{% extends 'base.html.twig' %}

{% block title %}{{ lesson.title }} | StudyCompanion+{% endblock %}

{% block body %}
    <section class="card" style="margin-bottom:1rem;">
        <h1>{{ lesson.title }}</h1>
        <p>{{ lesson.subject }} | Difficulty: {{ lesson.difficulty.value }} | Estimated study time: {{ lesson.estimatedStudyMinutes ?? 'Pending' }} minutes</p>
        <p class="note" style="margin-top:.55rem;">Processing status: <span class="badge {{ lesson.processingStatus.value == 'DONE' ? 'badge-done' : (lesson.processingStatus.value == 'FAILED' ? 'badge-failed' : 'badge-pending') }}">{{ lesson.processingStatus.value }}</span></p>
        {% set lessonIntegrations = lesson.thirdPartyMeta.integrations ?? {} %}
        {% if lessonIntegrations is not empty %}
            <div class="third-party-strip" style="margin-top:.8rem;">
                {% for provider, integration in lessonIntegrations %}
                    <span class="third-party-chip third-party-{{ integration.status|lower }}">
                        {{ provider }} - {{ integration.status }}
                    </span>
                {% endfor %}
            </div>
        {% endif %}
        {{ include('partials/third_party_links.html.twig', {meta: lesson.thirdPartyMeta}) }}
        <div style="display:flex; gap:.7rem; flex-wrap:wrap; margin-top:1rem;">
            {% if latestQuiz %}
                <a href="{{ path('student_quiz_take', {id: latestQuiz.id}) }}" class="btn btn-primary" style="display:inline-flex;">Start Adaptive Quiz</a>
            {% endif %}
            <form method="post" action="{{ path('student_lesson_regenerate_quiz', {id: lesson.id}) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('regenerate_quiz_' ~ lesson.id) }}">
                <button type="submit" class="btn">Generate New Quiz</button>
            </form>
        </div>
    </section>

    {% if latestReport %}
        <section class="card" style="margin-bottom:1rem;">
            <h2>Latest Mastery Report</h2>
            <div class="list-item">
                <div>
                    <strong>Score {{ latestReport.quizScore }}%</strong>
                    <div class="note">Weak topics: {{ latestReport.weakTopics is not empty ? latestReport.weakTopics|join(', ') : 'None' }}</div>
                    {% set latestIntegrations = latestReport.thirdPartyMeta.integrations ?? {} %}
                    {% set explanation = '' %}
                    {% for providerKey in ['GROQ_FREE', 'LOCAL_NLP', 'OPENAI'] %}
                        {% if explanation == '' and latestIntegrations[providerKey] is defined and latestIntegrations[providerKey].payload.evaluationExplanation is defined %}
                            {% set explanation = latestIntegrations[providerKey].payload.evaluationExplanation %}
                        {% endif %}
                    {% endfor %}
                    {% if explanation != '' %}
                        <div class="note">AI explanation: {{ explanation }}</div>
                    {% endif %}
                    {{ include('partials/third_party_links.html.twig', {meta: latestReport.thirdPartyMeta}) }}
                </div>
                <span class="badge {{ latestReport.masteryStatus.value == 'MASTERED' ? 'badge-mastered' : (latestReport.masteryStatus.value == 'NEEDS_REVIEW' ? 'badge-needs-review' : 'badge-not-mastered') }}">{{ latestReport.masteryStatus.value }}</span>
            </div>
        </section>
    {% endif %}

    <section class="card" style="margin-bottom:1rem;">
        <h2>Teacher Discussion</h2>
        <div class="chat-container" data-controller="chat-actions">
            <div class="chat-thread">
                {% for comment in lessonComments %}
                    {% set isMine = comment.authorRole == 'ROLE_STUDENT' %}
                    <article class="chat-row {{ isMine ? 'chat-row-me' : 'chat-row-peer' }}">
                        <div class="chat-bubble {{ isMine ? 'chat-bubble-me' : 'chat-bubble-peer' }}">
                            <div class="chat-header">
                                <strong class="chat-author">
                                    {% if comment.authorRole == 'ROLE_TEACHER' %}
                                        {{ comment.teacher and comment.teacher.user ? comment.teacher.user.name : 'Teacher' }}
                                    {% else %}
                                        You
                                    {% endif %}
                                </strong>
                                <span class="chat-time">{{ comment.createdAt|date('Y-m-d H:i') }}</span>
                            </div>
                            <p class="chat-text">{{ comment.content }}</p>
                            {% if comment.updatedAt %}
                                <span class="chat-edited">(edited)</span>
                            {% endif %}
                            {% set moderation = comment.thirdPartyMeta.integrations.GOOGLE_PERSPECTIVE ?? null %}
                            {% if moderation %}
                                <div class="note">Moderation: {{ moderation.status }}{% if moderation.payload.score is defined %} | Score {{ moderation.payload.score }}{% endif %}</div>
                            {% endif %}
                        </div>
                        {% if isMine %}
                            <button
                                type="button"
                                class="chat-actions-btn"
                                data-action="chat-actions#toggleMenu"
                                data-comment-id="{{ comment.id }}"
                                aria-label="Message actions"
                                title="Delete message"
                            >â‹¯</button>
                            <div class="chat-actions-menu" data-chat-actions-menu data-comment-id="{{ comment.id }}" hidden>
                                <form method="post" action="{{ path('student_lesson_comment_delete', {lessonId: lesson.id, commentId: comment.id}) }}" onsubmit="return confirm('Delete this message?');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('student_comment_delete_' ~ comment.id) }}">
                                    <button type="submit" class="action-item action-delete">Delete</button>
                                </form>
                            </div>
                        {% endif %}
                    </article>
                {% else %}
                    <div class="chat-empty">
                        <p class="note">No discussion yet for this lesson.</p>
                    </div>
                {% endfor %}
            </div>

            {% if lessonComments %}
                {% set hasTeacherMessage = false %}
                {% for comment in lessonComments %}
                    {% if comment.authorRole == 'ROLE_TEACHER' %}
                        {% set hasTeacherMessage = true %}
                    {% endif %}
                {% endfor %}

                {% if hasTeacherMessage %}
                    <form method="post" action="{{ path('student_lesson_comment_reply', {lessonId: lesson.id, commentId: lessonComments|last.id}) }}" class="chat-composer chat-composer-bottom">
                        <input type="hidden" name="_token" value="{{ csrf_token('student_reply_comment_' ~ (lessonComments|last.id ?? 0)) }}">
                        <textarea name="content" maxlength="2000" minlength="2" required placeholder="Type your reply..."></textarea>
                        <button type="submit" class="btn-primary">Send</button>
                    </form>
                {% endif %}
            {% endif %}
        </div>
    </section>

    <section class="card">
        <h2>Generated Study Materials</h2>
        <div class="list">
            {% for material in materials %}
                <article class="list-item" style="align-items:flex-start; flex-direction:column;">
                    <div style="width:100%; display:flex; justify-content:space-between; gap:.8rem;">
                        <strong>{{ material.type.value }} (v{{ material.version }})</strong>
                        <span class="note">{{ material.createdAt|date('Y-m-d H:i') }}</span>
                    </div>
                    {% set materialIntegrations = material.thirdPartyMeta.integrations ?? {} %}
                    {% if materialIntegrations is not empty %}
                        <div class="third-party-strip" style="margin-bottom:.45rem;">
                            {% for provider, integration in materialIntegrations %}
                                <span class="third-party-chip third-party-{{ integration.status|lower }}">{{ provider }} - {{ integration.status }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {{ include('partials/third_party_links.html.twig', {meta: material.thirdPartyMeta}) }}
                    {% if material.summary %}
                        <p>{{ material.summary }}</p>
                    {% elseif material.flashcards %}
                        <ul>
                            {% for flashcard in material.flashcards %}
                                <li><strong>{{ flashcard.front }}</strong>: {{ flashcard.back }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>{{ material.content|nl2br }}</p>
                    {% endif %}
                </article>
            {% else %}
                <p class="note">Materials are still being generated. Refresh this page in a moment.</p>
            {% endfor %}
        </div>
    </section>
{% endblock %}
